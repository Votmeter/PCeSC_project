<!DOCTYPE HTML>
<html>
<head>
    <title>Tracciamento Animali Selvatici</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="assets/css/main.css" />
    <!-- Includi il CSS di Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body class="landing is-preload">
<div id="page-wrapper">
    <!-- Header -->

    <header id="header" class="alt">
        <h1><a href="index.html"> Tracciamento Larus  </a></h1>
        <nav id="nav">
            <ul>
                <li>
                        <li><a href="informazioni.html">Informazioni</a></li>
                        <li>
                            <a href="index.html">Tracciamento Uccelli</a>
                            <ul>
                                <li><a href="traiettorie.html">Traiettorie</a></li>
                                <li><a href="corridoio_migratorio.html">Corridoio Migratorio</a></li>
                                <li><a href="traiettorie_traslocate.html">Trettorie Traslocate</a></li>
                                <li><a href="#">Inserisci dati</a></li>
                            </ul>
                        </li>
                    <li><a href="accedi.html" class="button">Login</a></li>
                </li>
            </ul>
        </nav>
    </header>




    <!-- Banner -->
    <section id="banner">
        <h2>Traiettorie</h2>
    </section>

    <!-- Main -->
    <section id="main" class="container">
        <section class="box special">
            <script>
                // Funzione per ottenere i nomi delle collezioni dal backend
                async function fetchCollections() {
                    const response = await fetch('/get_collections');
                    const collections = await response.json();
                    const dropdown = document.getElementById('collections-dropdown');
        
                    collections.forEach(collection => {
                        const option = document.createElement('option');
                        option.text = collection;
                        option.value = collection;
                        dropdown.add(option);
                    });
                }
        
                // Funzione per ottenere i documenti di una collezione selezionata
                async function fetchDocuments() {
                    const collectionName = event.target.value; // Get the selected value from the event object
                    const response = await fetch(`/get_documents/${collectionName}`);
                    const documents = await response.json();
                    const dropdown_li = document.getElementById('documents-dropdown');
        
                    
                    documents.forEach(collection => {
                        const option = document.createElement('option');
                        option.text = collection;
                        option.value = collection;
                        dropdown_li.add(option);
                    });
        
                }
        
                // Funzione per aggiungere una nuova collezione
                async function addCollection() {
                    const collectionName = document.getElementById('new-collection-name').value;
                    const collectionId = document.getElementById('new-collection-id').value
                    const collectionData = document.getElementById('new-collection-json').value;
        
                    try {
                        const response = await fetch('/add_collection', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                name: collectionName,
                                id: collectionId,
                                data: JSON.parse(collectionData)
                            })
                        });
        
                        if (response.ok) {
                            alert('Collezione aggiunta con successo!');
                            fetchCollections(); // Aggiorna la lista delle collezioni
                        } else {
                            alert('Errore nell\'aggiunta della collezione.');
                        }
                    } catch (error) {
                        alert('Errore nel formato JSON.');
                    }
                }
        
                // Funzione per caricare un file JSON e popolare la textarea
                function handleFileUpload(event) {
                    const file = event.target.files[0];
                    const reader = new FileReader();
        
                    reader.onload = function(event) {
                        const content = event.target.result;
                        document.getElementById('new-collection-json').value = content;
                    };
        
                    reader.readAsText(file);
                }
        
                async function updateDocumentDataText() {
                    const collectionName = document.getElementById('collections-dropdown').value;
                    const documentId = document.getElementById('documents-dropdown').value;
                    console.log(collectionName + "   " + documentId);
                    try {
                        const response = await fetch(`/${collectionName}/${documentId}`);
                        if (!response.ok) {
                            throw new Error('Errore nella caricazione del documento');
                        }
                        const content = await response.json();
                        document.getElementById('update-collection-json').value = JSON.stringify(content, null, 4);
                    } catch (error) {
                        alert('Errore nella caricazione del documento');
                        console.error(error);
                    }
                }
        
                async function updateCollection() {
                    const collectionName = document.getElementById('collections-dropdown').value;
                    const documentId = document.getElementById('documents-dropdown').value;
                    const updatedContent = document.getElementById('update-collection-json').value;
        
                    try {
                        const response = await fetch(`/${collectionName}/${documentId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: updatedContent
                        });
        
                        if (!response.ok) {
                            throw new Error('Errore nell\'aggiornamento del documento');
                        }
        
                        const result = await response.json();
                        if (result.success) {
                            alert('Documento aggiornato con successo');
                        } else {
                            alert('Errore nell\'aggiornamento del documento');
                        }
                    } catch (error) {
                        alert('Errore nell\'aggiornamento del documento');
                        console.error(error);
                    }
                }
        
        
        
                window.onload = fetchCollections;
            </script>
        </head>
<body>

        <h2>Modifica Traiettorie</h2>
        <!-- <label for="collections-dropdown">Seleziona larus</label> -->
        <select id="collections-dropdown" onchange="fetchDocuments()">
            <option value="" disabled selected>Seleziona Larus</option>
        </select>
        <br />
        <!-- <label for="documents-dropdown">Seleziona una coordinata</label> -->
        <select id="documents-dropdown" onchange = updateDocumentDataText()>
            <option value="" disabled selected>Seleziona Coordinata</option>
        </select>
        <br />
        <!-- <label for="update-collection-json">Collezione selezionata</label><br> -->
        <textarea id="update-collection-json" placeholder='Nessuna collezione selezionata'></textarea><br><br>
        <!-- <button onclick="updateCollection()" class="button primary">Aggiorna Collezione</button> -->
        <a  class="button primary" onclick="updateCollection()">Aggiorna</a>




        <h2>Aggiungi Coordinate della Traiettoria</h2>
        <!-- <label for="new-collection-name">Nome della nuova collezione:</label> -->
        <input type="text" id="new-collection-name" placeholder="Larus"><br><br>
        <!-- <label for="new-collection-id">ID / IDs dei nuovi Documenti:</label> -->
        <input type="text" id="new-collection-id" placeholder="Evento"><br><br>
        <!-- <label for="new-collection-json">Dati della collezione (formato JSON):</label><br> -->
        <textarea id="new-collection-json" placeholder='Nessuna traiettoria caricata'></textarea><br><br>
        <label for="file-upload">Carica un file JSON:</label>
        <input type="file" id="file-upload" accept=".json" onchange="handleFileUpload(event)" style="display:none;"><br><br>
        <!-- <button onclick="addCollection()">Aggiungi Collezione</button> -->
        <a  class="button primary" onclick="addCollection()">Aggiungi</a>





    <!-- <div class="left-panel">
        <h2>Modifica traettoria Larus</h2>
        <label for="collections-dropdown">Seleziona Larus:</label>
        <select id="collections-dropdown" onchange="fetchDocuments()">
            <option value="" disabled selected>Seleziona</option>
        </select>
        <br />
        <label for="documents-dropdown">Seleziona traiettoria:</label>
        <select id="documents-dropdown" onchange = updateDocumentDataText()>
            <option value="" disabled selected>Seleziona</option>
        </select>
        <br />
        <label for="update-collection-json">Collezione selezionata</label><br>
        <textarea id="update-collection-json" placeholder='Nessuna collezione selezionata'></textarea><br><br>



    </div>
    <div class="right-panel">
        <h2>Aggiungi Traettoria</h2>
        <label for="new-collection-name">Nome della nuova traettoria:</label>
        <input type="text" id="new-collection-name"><br><br>
        <label for="new-collection-id">ID / IDs dei nuovi Documenti:</label>
        <input type="text" id="new-collection-id"><br><br>
        <label for="new-collection-json">Dati della traettoria:</label><br>
        <textarea id="new-collection-json" placeholder='{"documento1": {"campo1": "valore1"}, "documento2": {"campo1": "valore2"}}'></textarea><br><br>
        <label for="file-upload">Carica un file JSON:</label>
        <input type="file" id="file-upload" accept=".json" onchange="handleFileUpload(event)"><br><br>
        <button onclick="addCollection()">Aggiungi Traettoria</button>
    </div>
        </section>
    </section>
</div> -->

<!-- Scripts -->
<script src="assets/js/jquery.min.js"></script>
<script src="assets/js/jquery.dropotron.min.js"></script>
<script src="assets/js/jquery.scrollex.min.js"></script>
<script src="assets/js/browser.min.js"></script>
<script src="assets/js/breakpoints.min.js"></script>
<script src="assets/js/util.js"></script>
<script src="assets/js/main.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

</body>
</html>
